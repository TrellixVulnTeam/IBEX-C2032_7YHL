{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import glob\n",
    "from collections import OrderedDict,defaultdict\n",
    "import pipes\n",
    "import pprint\n",
    "import tempfile\n",
    "import re"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "root_dir = 'K562_Long_data'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "####Fixed length 1e6 = 100 blocks. \n",
    "####Fixed length 5e5 = 200 blocks. \n",
    "Fixed_length = 1e6"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "def binary_locate(array,ele,start,end):\n",
    "    middle = (end+start)//2\n",
    "    if(end-start>1):\n",
    "        if(array[middle]<ele):\n",
    "            return binary_locate(array,ele,middle,end)\n",
    "        elif(array[middle+1]>ele):\n",
    "            return binary_locate(array,ele,start,middle)\n",
    "        else:\n",
    "            return middle,middle+1\n",
    "    else:\n",
    "        return middle,middle+1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "p = pipes.Template()\n",
    "p.append(\"zcat\", '--')\n",
    "Gene_Loc = defaultdict(list)\n",
    "f = p.open('/home/longy/cnda/ensembl/Homo_sapiens.GRCh38.102.gtf.gz', 'r')\n",
    "\n",
    "#f = p.open('/home/longy/cnda/ensembl/Mus_musculus.GRCm38.102.gtf.gz', 'r')\n",
    "for line in f.readlines():\n",
    "    if re.match('^#',line):\n",
    "        continue\n",
    "    line = line.rstrip('\\n')\n",
    "    data = line.split('\\t')\n",
    "    if(data[2] == 'gene'):\n",
    "        Gene_Loc['chr'+data[0]+data[6]].append(int(data[3]))\n",
    "        Gene_Loc['chr'+data[0]+data[6]].append(int(data[4]))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "(1527, 1528)"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import sys\n",
    "sys.setrecursionlimit(10000)\n",
    "array = Gene_Loc['chr1+']\n",
    "binary_locate(array,46104790,0,3505)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "writing file K562_Long_data/Blocks/chr2_-_0_218162-57889682\n",
      "writing file K562_Long_data/Blocks/chr2_-_1_57976646-107717247\n",
      "writing file K562_Long_data/Blocks/chr2_-_2_107744535-177386750\n",
      "writing file K562_Long_data/Blocks/chr2_-_3_177387869-242175374\n",
      "writing file K562_Long_data/Blocks/chr20_-_0_270971-64324137\n",
      "writing file K562_Long_data/Blocks/chr22_-_0_10749564-50783639\n",
      "writing file K562_Long_data/Blocks/chr13_+_0_18171261-114327327\n",
      "writing file K562_Long_data/Blocks/chr3_+_0_3126950-39096736\n",
      "writing file K562_Long_data/Blocks/chr3_+_1_39128877-95172859\n",
      "writing file K562_Long_data/Blocks/chr3_+_2_95685010-152465845\n",
      "writing file K562_Long_data/Blocks/chr3_+_3_152596475-198230037\n",
      "writing file K562_Long_data/Blocks/chr1_-_0_14328-23868325\n",
      "writing file K562_Long_data/Blocks/chr1_-_1_23962672-52021020\n",
      "writing file K562_Long_data/Blocks/chr1_-_2_52022411-110927719\n",
      "writing file K562_Long_data/Blocks/chr1_-_3_110937870-156623016\n",
      "writing file K562_Long_data/Blocks/chr1_-_4_156624294-205288184\n",
      "writing file K562_Long_data/Blocks/chr1_-_5_205302526-248936776\n",
      "writing file K562_Long_data/Blocks/chr20_+_0_171754-64296939\n",
      "writing file K562_Long_data/Blocks/chr3_-_0_3097819-48089109\n",
      "writing file K562_Long_data/Blocks/chr3_-_1_48157106-112562190\n",
      "writing file K562_Long_data/Blocks/chr3_-_2_112605553-156711799\n",
      "writing file K562_Long_data/Blocks/chr3_-_3_156713239-198080659\n",
      "writing file K562_Long_data/Blocks/chr11_+_0_130033-46242650\n",
      "writing file K562_Long_data/Blocks/chr11_+_1_46243802-74986058\n",
      "writing file K562_Long_data/Blocks/chr11_+_2_74988669-134763589\n",
      "writing file K562_Long_data/Blocks/chr16_+_0_22975-30727043\n",
      "writing file K562_Long_data/Blocks/chr16_+_1_30728439-90228153\n",
      "writing file K562_Long_data/Blocks/chr22_+_0_10752764-50800411\n",
      "writing file K562_Long_data/Blocks/chr12_-_0_14450-49131415\n",
      "writing file K562_Long_data/Blocks/chr12_-_1_49184776-100037762\n",
      "writing file K562_Long_data/Blocks/chr12_-_2_100039506-133130180\n",
      "writing file K562_Long_data/Blocks/chrX_+_0_20986-72262861\n",
      "writing file K562_Long_data/Blocks/chrX_+_1_72275052-156025730\n",
      "writing file K562_Long_data/Blocks/chr5_-_0_196939-72108224\n",
      "writing file K562_Long_data/Blocks/chr5_-_1_72217544-134648727\n",
      "writing file K562_Long_data/Blocks/chr5_-_2_134770897-181277797\n",
      "writing file K562_Long_data/Blocks/chr6_+_0_180563-30928278\n",
      "writing file K562_Long_data/Blocks/chr6_+_1_31158533-64025707\n",
      "writing file K562_Long_data/Blocks/chr6_+_2_64026989-132818927\n",
      "writing file K562_Long_data/Blocks/chr6_+_3_133174121-170745743\n",
      "writing file K562_Long_data/Blocks/chr2_+_0_264897-54616371\n",
      "writing file K562_Long_data/Blocks/chr2_+_1_54617619-99406390\n",
      "writing file K562_Long_data/Blocks/chr2_+_2_100562970-158682759\n",
      "writing file K562_Long_data/Blocks/chr2_+_3_159003822-200900150\n",
      "writing file K562_Long_data/Blocks/chr2_+_4_200902091-242180823\n",
      "writing file K562_Long_data/Blocks/chr4_-_0_37332-70899715\n",
      "writing file K562_Long_data/Blocks/chr4_-_1_70901738-126198983\n",
      "writing file K562_Long_data/Blocks/chr4_-_2_126346694-190109262\n",
      "writing file K562_Long_data/Blocks/chr10_+_0_135014-73631510\n",
      "writing file K562_Long_data/Blocks/chr10_+_1_73730210-133784732\n",
      "writing file K562_Long_data/Blocks/chr7_-_0_19536-42932204\n",
      "writing file K562_Long_data/Blocks/chr7_-_1_42952093-97943727\n",
      "writing file K562_Long_data/Blocks/chr7_-_2_97960099-123749046\n",
      "writing file K562_Long_data/Blocks/chr7_-_3_124820057-158829544\n",
      "writing file K562_Long_data/Blocks/chr8_+_0_232401-66929089\n",
      "writing file K562_Long_data/Blocks/chr8_+_1_66932070-145061158\n",
      "writing file K562_Long_data/Blocks/chr5_+_0_195940-71567851\n",
      "writing file K562_Long_data/Blocks/chr5_+_1_71572391-133065113\n",
      "writing file K562_Long_data/Blocks/chr5_+_2_133067427-181478046\n",
      "writing file K562_Long_data/Blocks/chr19_-_0_60356-14496176\n",
      "writing file K562_Long_data/Blocks/chr19_-_1_14514697-42255141\n",
      "writing file K562_Long_data/Blocks/chr19_-_2_42272747-58599346\n",
      "writing file K562_Long_data/Blocks/chr12_+_0_39115-51992972\n",
      "writing file K562_Long_data/Blocks/chr12_+_1_51993978-100341776\n",
      "writing file K562_Long_data/Blocks/chr12_+_2_100573689-133207481\n",
      "writing file K562_Long_data/Blocks/chr18_+_0_112511-80162203\n",
      "writing file K562_Long_data/Blocks/chr19_+_0_80738-17982042\n",
      "writing file K562_Long_data/Blocks/chr19_+_1_17988476-44666357\n",
      "writing file K562_Long_data/Blocks/chr19_+_2_44748734-58605093\n",
      "writing file K562_Long_data/Blocks/chr18_-_0_210444-80202782\n",
      "writing file K562_Long_data/Blocks/chr10_-_0_133585-71851299\n",
      "writing file K562_Long_data/Blocks/chr10_-_1_71888693-133559267\n",
      "writing file K562_Long_data/Blocks/chr15_-_0_20003557-62230664\n",
      "writing file K562_Long_data/Blocks/chr15_-_1_62242025-101954416\n",
      "writing file K562_Long_data/Blocks/chrX_-_0_303527-77822837\n",
      "writing file K562_Long_data/Blocks/chrX_-_1_77826295-156016821\n",
      "writing file K562_Long_data/Blocks/chr15_+_0_17033241-64160120\n",
      "writing file K562_Long_data/Blocks/chr15_+_1_64387849-101976451\n",
      "writing file K562_Long_data/Blocks/chr9_+_0_29903-98053870\n",
      "writing file K562_Long_data/Blocks/chr9_+_1_98056412-138319028\n",
      "writing file K562_Long_data/Blocks/chr14_+_0_19062392-64990181\n",
      "writing file K562_Long_data/Blocks/chr14_+_1_65004258-106628622\n",
      "writing file K562_Long_data/Blocks/chr21_-_0_5064139-46458423\n",
      "writing file K562_Long_data/Blocks/chr9_-_0_14444-98192649\n",
      "writing file K562_Long_data/Blocks/chr9_-_1_98199073-137874123\n",
      "writing file K562_Long_data/Blocks/chr13_-_0_18834049-114230251\n",
      "writing file K562_Long_data/Blocks/chr11_-_0_119155-46243637\n",
      "writing file K562_Long_data/Blocks/chr11_-_1_46256145-74845746\n",
      "writing file K562_Long_data/Blocks/chr11_-_2_74846768-134762362\n",
      "writing file K562_Long_data/Blocks/chr6_-_0_68372-31356941\n",
      "writing file K562_Long_data/Blocks/chr6_-_1_31394259-80066111\n",
      "writing file K562_Long_data/Blocks/chr6_-_2_81745972-127318654\n",
      "writing file K562_Long_data/Blocks/chr6_-_3_127319676-170745686\n",
      "writing file K562_Long_data/Blocks/chr4_+_0_53290-48298012\n",
      "writing file K562_Long_data/Blocks/chr4_+_1_48301539-109531594\n",
      "writing file K562_Long_data/Blocks/chr4_+_2_109532649-190202615\n",
      "writing file K562_Long_data/Blocks/chr7_+_0_27744-40749569\n",
      "writing file K562_Long_data/Blocks/chr7_+_1_40860328-94557193\n",
      "writing file K562_Long_data/Blocks/chr7_+_2_94559537-128531872\n",
      "writing file K562_Long_data/Blocks/chr7_+_3_128533657-159113373\n",
      "writing file K562_Long_data/Blocks/chr17_-_0_62277-30289774\n",
      "writing file K562_Long_data/Blocks/chr17_-_1_30291219-58007615\n",
      "writing file K562_Long_data/Blocks/chr17_-_2_58202751-83231224\n",
      "writing file K562_Long_data/Blocks/chr21_+_0_5062605-46695386\n",
      "writing file K562_Long_data/Blocks/chr1_+_0_137539-27886746\n",
      "writing file K562_Long_data/Blocks/chr1_+_1_27934997-53051684\n",
      "writing file K562_Long_data/Blocks/chr1_+_2_53196790-111468499\n",
      "writing file K562_Long_data/Blocks/chr1_+_3_111469984-161608323\n",
      "writing file K562_Long_data/Blocks/chr1_+_4_161621624-204432391\n",
      "writing file K562_Long_data/Blocks/chr1_+_5_204433869-248940813\n",
      "writing file K562_Long_data/Blocks/chr8_-_0_70939-90908880\n",
      "writing file K562_Long_data/Blocks/chr8_-_1_90946769-145004824\n",
      "writing file K562_Long_data/Blocks/chr17_+_0_413374-30865892\n",
      "writing file K562_Long_data/Blocks/chr17_+_1_30868326-50756192\n",
      "writing file K562_Long_data/Blocks/chr17_+_2_50866657-83244868\n",
      "writing file K562_Long_data/Blocks/chr14_-_0_19082933-60248901\n",
      "writing file K562_Long_data/Blocks/chr14_-_1_60436162-106482367\n",
      "writing file K562_Long_data/Blocks/chr16_-_0_14101-30880304\n",
      "writing file K562_Long_data/Blocks/chr16_-_1_30887723-90228172\n"
     ]
    }
   ],
   "source": [
    "total = 0\n",
    "files = glob.glob(root_dir+\"/*.txt\")\n",
    "info = open(root_dir+'/Blocks/info.txt','w')\n",
    "info.write('ID\\tstart\\tend\\tlength\\tsites_num\\n')\n",
    "for file in files:\n",
    "    num_lines = sum(1 for line in open(file))\n",
    "    num_blocks = round(num_lines/Fixed_length)\n",
    "    len_blocks = num_lines/num_blocks\n",
    "    \n",
    "    f= open(file,'r')\n",
    "    pre_pos = 0\n",
    "    dict_line = OrderedDict()\n",
    "    #dict_line = dict()\n",
    "    count = 0\n",
    "    separate_num=0\n",
    "    save_block = 0\n",
    "    start = 0\n",
    "    \n",
    "    for i, line in enumerate(f):\n",
    "        line = line.rstrip('\\n')\n",
    "        if(i==0):\n",
    "            continue ###Skip header\n",
    "        chromosome,pos,strand = line.split('\\t')[0].split(':')\n",
    "        pos = int(pos)\n",
    "        count += 1\n",
    "        if(i==1):\n",
    "            start=pos\n",
    "        if(count>len_blocks and pos-pre_pos>1000 and save_block<num_blocks-1):\n",
    "            array = Gene_Loc[chromosome+strand]\n",
    "            index1,index2 = binary_locate(array,pre_pos,0,len(array)-1)\n",
    "            if(index1%2==1 and index2%2==0):\n",
    "                ww = open(root_dir+'/Blocks/%s_%s_%d'%(chromosome,strand,save_block),'w')\n",
    "                print('writing file '+root_dir+'/Blocks/%s_%s_%d_%d-%d'%(chromosome,strand,save_block,start,pre_pos))\n",
    "                info.write('%s_%s_%d\\t%d\\t%d\\t%d\\t%d\\n'%(chromosome,strand,save_block,start,pre_pos,pre_pos-start,count))\n",
    "                #print('%s_%s_%d\\t%d\\t%d\\t%d\\t%d\\n'%(chromosome,strand,save_block,start,pre_pos,pre_pos-start,count))\n",
    "                for key,val in dict_line.items():\n",
    "                    ww.write('%s\\n'%val)\n",
    "                ww.close()\n",
    "                dict_line.clear()\n",
    "                count = 0\n",
    "                save_block += 1\n",
    "                start  = pos\n",
    "            \n",
    "        \n",
    "        dict_line[pos] = line\n",
    "        pre_pos = pos\n",
    "        \n",
    "    out = open(root_dir+'/Blocks/%s_%s_%d'%(chromosome,strand,save_block),'w')\n",
    "    print('writing file '+root_dir+'/Blocks/%s_%s_%d_%d-%d'%(chromosome,strand,save_block,start,pre_pos))\n",
    "    info.write('%s_%s_%d\\t%d\\t%d\\t%d\\t%d\\n'%(chromosome,strand,save_block,start,pre_pos,pre_pos-start,count))\n",
    "    for key,val in dict_line.items():\n",
    "        out.write('%s\\n'%(val))\n",
    "    out.close()\n",
    "\n",
    "info.close()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
