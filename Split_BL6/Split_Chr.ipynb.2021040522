{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import glob\n",
    "from collections import OrderedDict,defaultdict\n",
    "import pipes\n",
    "import pprint\n",
    "import tempfile\n",
    "import re"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "root_dir = 'K562_Chen_data'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "####Fixed length 1e6 = 100 blocks. \n",
    "####Fixed length 5e5 = 200 blocks. \n",
    "Fixed_length = 2e6"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "def binary_locate(array,ele,start,end):\n",
    "    middle = (end+start)//2\n",
    "    if(end-start>1):\n",
    "        if(array[middle]<ele):\n",
    "            return binary_locate(array,ele,middle,end)\n",
    "        elif(array[middle+1]>ele):\n",
    "            return binary_locate(array,ele,start,middle)\n",
    "        else:\n",
    "            return middle,middle+1\n",
    "    else:\n",
    "        return middle,middle+1"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "p = pipes.Template()\n",
    "p.append(\"zcat\", '--')\n",
    "Gene_Loc = defaultdict(list)\n",
    "f = p.open('/home/longy/cnda/ensembl/Homo_sapiens.GRCh38.102.gtf.gz', 'r')\n",
    "\n",
    "#f = p.open('/home/longy/cnda/ensembl/Mus_musculus.GRCm38.102.gtf.gz', 'r')\n",
    "for line in f.readlines():\n",
    "    if re.match('^#',line):\n",
    "        continue\n",
    "    line = line.rstrip('\\n')\n",
    "    data = line.split('\\t')\n",
    "    if(data[2] == 'gene'):\n",
    "        Gene_Loc['chr'+data[0]+data[6]].append(int(data[3]))\n",
    "        Gene_Loc['chr'+data[0]+data[6]].append(int(data[4]))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "(1527, 1528)"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import sys\n",
    "sys.setrecursionlimit(10000)\n",
    "array = Gene_Loc['chr1+']\n",
    "binary_locate(array,46104790,0,3505)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "writing file K562_Chen_data/Blocks/chr18_-_0_47934-36129805\n",
      "writing file K562_Chen_data/Blocks/chr18_-_1_36154831-80247429\n",
      "writing file K562_Chen_data/Blocks/chr20_-_0_214892-35699390\n",
      "writing file K562_Chen_data/Blocks/chr20_-_1_35702117-64333153\n",
      "writing file K562_Chen_data/Blocks/chr20_+_0_130003-36049751\n",
      "writing file K562_Chen_data/Blocks/chr20_+_1_36052745-64329721\n",
      "writing file K562_Chen_data/Blocks/chr2_-_0_39294-37232238\n",
      "writing file K562_Chen_data/Blocks/chr2_-_1_37249059-65436063\n",
      "writing file K562_Chen_data/Blocks/chr2_-_2_65444393-96974560\n",
      "writing file K562_Chen_data/Blocks/chr2_-_3_96977830-133263690\n",
      "writing file K562_Chen_data/Blocks/chr2_-_4_133286779-171858210\n",
      "writing file K562_Chen_data/Blocks/chr2_-_5_171861232-201903143\n",
      "writing file K562_Chen_data/Blocks/chr2_-_6_201985460-242180305\n",
      "writing file K562_Chen_data/Blocks/chr5_+_0_50730-36962367\n",
      "writing file K562_Chen_data/Blocks/chr5_+_1_36964430-71568503\n",
      "writing file K562_Chen_data/Blocks/chr5_+_2_71570741-96919734\n",
      "writing file K562_Chen_data/Blocks/chr5_+_3_96933477-128966690\n",
      "writing file K562_Chen_data/Blocks/chr5_+_4_128968060-150558283\n",
      "writing file K562_Chen_data/Blocks/chr5_+_5_150594513-181478096\n",
      "writing file K562_Chen_data/Blocks/chr12_+_0_11688-26837044\n",
      "writing file K562_Chen_data/Blocks/chr12_+_1_26922606-53196196\n",
      "writing file K562_Chen_data/Blocks/chr12_+_2_53201069-79433653\n",
      "writing file K562_Chen_data/Blocks/chr12_+_3_79438396-110742946\n",
      "writing file K562_Chen_data/Blocks/chr12_+_4_110819768-133225754\n",
      "writing file K562_Chen_data/Blocks/chr17_-_0_61654-20903505\n",
      "writing file K562_Chen_data/Blocks/chr17_-_1_20986083-43152240\n",
      "writing file K562_Chen_data/Blocks/chr17_-_2_43153651-64132902\n",
      "writing file K562_Chen_data/Blocks/chr17_-_3_64140872-83241808\n",
      "writing file K562_Chen_data/Blocks/chr6_-_0_67416-27322516\n",
      "writing file K562_Chen_data/Blocks/chr6_-_1_27332743-39631963\n",
      "writing file K562_Chen_data/Blocks/chr6_-_2_39634750-84273312\n",
      "writing file K562_Chen_data/Blocks/chr6_-_3_84309268-111365336\n",
      "writing file K562_Chen_data/Blocks/chr6_-_4_111367043-141656644\n",
      "writing file K562_Chen_data/Blocks/chr6_-_5_141657758-170745736\n",
      "writing file K562_Chen_data/Blocks/chr7_-_0_12872-23014131\n",
      "writing file K562_Chen_data/Blocks/chr7_-_1_23016843-55720905\n",
      "writing file K562_Chen_data/Blocks/chr7_-_2_55725978-93230161\n",
      "writing file K562_Chen_data/Blocks/chr7_-_3_93232038-110849220\n",
      "writing file K562_Chen_data/Blocks/chr7_-_4_110853979-135548581\n",
      "writing file K562_Chen_data/Blocks/chr7_-_5_135557721-159335436\n",
      "writing file K562_Chen_data/Blocks/chrX_-_0_11609-50308651\n",
      "writing file K562_Chen_data/Blocks/chrX_-_1_50310420-118263572\n",
      "writing file K562_Chen_data/Blocks/chrX_-_2_118265878-156028488\n",
      "writing file K562_Chen_data/Blocks/chr1_-_0_12987-19252352\n",
      "writing file K562_Chen_data/Blocks/chr1_-_1_19255465-36397920\n",
      "writing file K562_Chen_data/Blocks/chr1_-_2_36414285-55221787\n",
      "writing file K562_Chen_data/Blocks/chr1_-_3_55501797-93447909\n",
      "writing file K562_Chen_data/Blocks/chr1_-_4_93516170-145888959\n",
      "writing file K562_Chen_data/Blocks/chr1_-_5_145891509-161203531\n",
      "writing file K562_Chen_data/Blocks/chr1_-_6_161210262-194933146\n",
      "writing file K562_Chen_data/Blocks/chr1_-_7_194994332-224434794\n",
      "writing file K562_Chen_data/Blocks/chr1_-_8_224462489-248936826\n",
      "writing file K562_Chen_data/Blocks/chr22_+_0_10685481-31207073\n",
      "writing file K562_Chen_data/Blocks/chr22_+_1_31212215-50804637\n",
      "writing file K562_Chen_data/Blocks/chr22_-_0_10529025-30328936\n",
      "writing file K562_Chen_data/Blocks/chr22_-_1_30331916-50804637\n",
      "writing file K562_Chen_data/Blocks/chr8_+_0_67090-30767068\n",
      "writing file K562_Chen_data/Blocks/chr8_+_1_30797616-69682427\n",
      "writing file K562_Chen_data/Blocks/chr8_+_2_69716688-103768872\n",
      "writing file K562_Chen_data/Blocks/chr8_+_3_103785934-145067168\n",
      "writing file K562_Chen_data/Blocks/chr16_+_0_10798-20925114\n",
      "writing file K562_Chen_data/Blocks/chr16_+_1_20941271-67101133\n",
      "writing file K562_Chen_data/Blocks/chr16_+_2_67109960-90228203\n",
      "writing file K562_Chen_data/Blocks/chr4_-_0_34853-36965881\n",
      "writing file K562_Chen_data/Blocks/chr4_-_1_36988030-77081026\n",
      "writing file K562_Chen_data/Blocks/chr4_-_2_77082414-108620477\n",
      "writing file K562_Chen_data/Blocks/chr4_-_3_108648376-144211001\n",
      "writing file K562_Chen_data/Blocks/chr4_-_4_144216021-190118373\n",
      "writing file K562_Chen_data/Blocks/chr2_+_0_262641-32583556\n",
      "writing file K562_Chen_data/Blocks/chr2_+_1_32584752-62944394\n",
      "writing file K562_Chen_data/Blocks/chr2_+_2_62946341-88751147\n",
      "writing file K562_Chen_data/Blocks/chr2_+_3_88752431-122914974\n",
      "writing file K562_Chen_data/Blocks/chr2_+_4_122964434-162546914\n",
      "writing file K562_Chen_data/Blocks/chr2_+_5_162602929-187418082\n",
      "writing file K562_Chen_data/Blocks/chr2_+_6_187436510-215380314\n",
      "writing file K562_Chen_data/Blocks/chr2_+_7_215381475-242181456\n",
      "writing file K562_Chen_data/Blocks/chr21_+_0_5026530-46699316\n",
      "writing file K562_Chen_data/Blocks/chr21_-_0_5031838-46694033\n",
      "writing file K562_Chen_data/Blocks/chr3_+_0_144167-23925204\n",
      "writing file K562_Chen_data/Blocks/chr3_+_1_23926824-49671584\n",
      "writing file K562_Chen_data/Blocks/chr3_+_2_49673174-100751726\n",
      "writing file K562_Chen_data/Blocks/chr3_+_3_100754603-135270344\n",
      "writing file K562_Chen_data/Blocks/chr3_+_4_135494614-170307431\n",
      "writing file K562_Chen_data/Blocks/chr3_+_5_170309144-198230087\n",
      "writing file K562_Chen_data/Blocks/chr18_+_0_37677-31478705\n",
      "writing file K562_Chen_data/Blocks/chr18_+_1_31497940-80263074\n",
      "writing file K562_Chen_data/Blocks/chr9_+_0_12641-40109131\n",
      "writing file K562_Chen_data/Blocks/chr9_+_1_40111987-94813638\n",
      "writing file K562_Chen_data/Blocks/chr9_+_2_94817232-124877805\n",
      "writing file K562_Chen_data/Blocks/chr9_+_3_124888285-138334465\n",
      "writing file K562_Chen_data/Blocks/chr11_+_0_123368-20514357\n",
      "writing file K562_Chen_data/Blocks/chr11_+_1_20555271-61355640\n",
      "writing file K562_Chen_data/Blocks/chr11_+_2_61357135-71751835\n",
      "writing file K562_Chen_data/Blocks/chr11_+_3_71772475-107904467\n",
      "writing file K562_Chen_data/Blocks/chr11_+_4_107908374-134897563\n",
      "writing file K562_Chen_data/Blocks/chr4_+_0_18819-25418788\n",
      "writing file K562_Chen_data/Blocks/chr4_+_1_25441540-70810809\n",
      "writing file K562_Chen_data/Blocks/chr4_+_2_70839482-103457479\n",
      "writing file K562_Chen_data/Blocks/chr4_+_3_103462138-140558395\n",
      "writing file K562_Chen_data/Blocks/chr4_+_4_140559869-190203219\n",
      "writing file K562_Chen_data/Blocks/chr12_-_0_12496-25607313\n",
      "writing file K562_Chen_data/Blocks/chr12_-_1_25611770-53828406\n",
      "writing file K562_Chen_data/Blocks/chr12_-_2_53870717-79834892\n",
      "writing file K562_Chen_data/Blocks/chr12_-_3_79843629-112003935\n",
      "writing file K562_Chen_data/Blocks/chr12_-_4_112005185-133258142\n",
      "writing file K562_Chen_data/Blocks/chr7_+_0_20714-24695545\n",
      "writing file K562_Chen_data/Blocks/chr7_+_1_24698900-65055538\n",
      "writing file K562_Chen_data/Blocks/chr7_+_2_65057409-93106325\n",
      "writing file K562_Chen_data/Blocks/chr7_+_3_93111380-112920813\n",
      "writing file K562_Chen_data/Blocks/chr7_+_4_112940381-139426716\n",
      "writing file K562_Chen_data/Blocks/chr7_+_5_139435530-159291636\n",
      "writing file K562_Chen_data/Blocks/chr16_-_0_10003-19752601\n",
      "writing file K562_Chen_data/Blocks/chr16_-_1_19845174-67249160\n",
      "writing file K562_Chen_data/Blocks/chr16_-_2_67250271-90228222\n",
      "writing file K562_Chen_data/Blocks/chr6_+_0_142737-27153256\n",
      "writing file K562_Chen_data/Blocks/chr6_+_1_27157153-38887076\n",
      "writing file K562_Chen_data/Blocks/chr6_+_2_38889342-70862080\n",
      "writing file K562_Chen_data/Blocks/chr6_+_3_70870254-116526181\n",
      "writing file K562_Chen_data/Blocks/chr6_+_4_116570947-146557927\n",
      "writing file K562_Chen_data/Blocks/chr6_+_5_146599189-170745793\n",
      "writing file K562_Chen_data/Blocks/chr15_-_0_17030783-50651462\n",
      "writing file K562_Chen_data/Blocks/chr15_-_1_50654966-75455797\n",
      "writing file K562_Chen_data/Blocks/chr15_-_2_75462608-101977082\n",
      "writing file K562_Chen_data/Blocks/chr13_-_0_18171262-52450655\n",
      "writing file K562_Chen_data/Blocks/chr13_-_1_52451966-114324788\n",
      "writing file K562_Chen_data/Blocks/chrX_+_0_15210-49329398\n",
      "writing file K562_Chen_data/Blocks/chrX_+_1_49330460-111766231\n",
      "writing file K562_Chen_data/Blocks/chrX_+_2_111776692-156026293\n",
      "writing file K562_Chen_data/Blocks/chr1_+_0_12858-20649304\n",
      "writing file K562_Chen_data/Blocks/chr1_+_1_20650446-39008051\n",
      "writing file K562_Chen_data/Blocks/chr1_+_2_39026306-62865900\n",
      "writing file K562_Chen_data/Blocks/chr1_+_3_62869686-100520929\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "writing file K562_Chen_data/Blocks/chr1_+_4_100534758-148149783\n",
      "writing file K562_Chen_data/Blocks/chr1_+_5_148151680-167585563\n",
      "writing file K562_Chen_data/Blocks/chr1_+_6_167587822-196540801\n",
      "writing file K562_Chen_data/Blocks/chr1_+_7_196543133-222947018\n",
      "writing file K562_Chen_data/Blocks/chr1_+_8_222983097-248945625\n",
      "writing file K562_Chen_data/Blocks/chr19_-_0_60066-11155841\n",
      "writing file K562_Chen_data/Blocks/chr19_-_1_11160603-32631483\n",
      "writing file K562_Chen_data/Blocks/chr19_-_2_32632596-47113780\n",
      "writing file K562_Chen_data/Blocks/chr19_-_3_47169853-58599827\n",
      "writing file K562_Chen_data/Blocks/chr5_-_0_16040-41870913\n",
      "writing file K562_Chen_data/Blocks/chr5_-_1_41907660-81751957\n",
      "writing file K562_Chen_data/Blocks/chr5_-_2_81755518-119767942\n",
      "writing file K562_Chen_data/Blocks/chr5_-_3_119769226-149464628\n",
      "writing file K562_Chen_data/Blocks/chr5_-_4_149470250-181470916\n",
      "writing file K562_Chen_data/Blocks/chr10_-_0_55418-27341222\n",
      "writing file K562_Chen_data/Blocks/chr10_-_1_27349203-70233931\n",
      "writing file K562_Chen_data/Blocks/chr10_-_2_70253865-98268216\n",
      "writing file K562_Chen_data/Blocks/chr10_-_3_98300552-133770304\n",
      "writing file K562_Chen_data/Blocks/chr19_+_0_71036-13090462\n",
      "writing file K562_Chen_data/Blocks/chr19_+_1_13093865-35315434\n",
      "writing file K562_Chen_data/Blocks/chr19_+_2_35318281-48466835\n",
      "writing file K562_Chen_data/Blocks/chr19_+_3_48469220-58605506\n",
      "writing file K562_Chen_data/Blocks/chr3_-_0_376217-37244188\n",
      "writing file K562_Chen_data/Blocks/chr3_-_1_37259632-53926733\n",
      "writing file K562_Chen_data/Blocks/chr3_-_2_53947195-113363520\n",
      "writing file K562_Chen_data/Blocks/chr3_-_3_113364747-138834938\n",
      "writing file K562_Chen_data/Blocks/chr3_-_4_138898164-179262551\n",
      "writing file K562_Chen_data/Blocks/chr3_-_5_179264211-198217563\n",
      "writing file K562_Chen_data/Blocks/chr9_-_0_12959-37905677\n",
      "writing file K562_Chen_data/Blocks/chr9_-_1_37911440-95907282\n",
      "writing file K562_Chen_data/Blocks/chr9_-_2_95954698-123171647\n",
      "writing file K562_Chen_data/Blocks/chr9_-_3_123173023-138269677\n",
      "writing file K562_Chen_data/Blocks/chr8_-_0_61153-38969554\n",
      "writing file K562_Chen_data/Blocks/chr8_-_1_38972334-85220451\n",
      "writing file K562_Chen_data/Blocks/chr8_-_2_85255192-118111887\n",
      "writing file K562_Chen_data/Blocks/chr8_-_3_118215898-145053252\n",
      "writing file K562_Chen_data/Blocks/chr11_-_0_67378-15983686\n",
      "writing file K562_Chen_data/Blocks/chr11_-_1_15986132-57454596\n",
      "writing file K562_Chen_data/Blocks/chr11_-_2_57456595-72103376\n",
      "writing file K562_Chen_data/Blocks/chr11_-_3_72105833-101228182\n",
      "writing file K562_Chen_data/Blocks/chr11_-_4_101233028-135056647\n",
      "writing file K562_Chen_data/Blocks/chr13_+_0_18171261-52479580\n",
      "writing file K562_Chen_data/Blocks/chr13_+_1_52494530-114349135\n",
      "writing file K562_Chen_data/Blocks/chr17_+_0_65501-22429211\n",
      "writing file K562_Chen_data/Blocks/chr17_+_1_22430655-42580673\n",
      "writing file K562_Chen_data/Blocks/chr17_+_2_42584944-62455762\n",
      "writing file K562_Chen_data/Blocks/chr17_+_3_62478778-83244918\n",
      "writing file K562_Chen_data/Blocks/chr14_-_0_16023969-49688471\n",
      "writing file K562_Chen_data/Blocks/chr14_-_1_49690483-74923523\n",
      "writing file K562_Chen_data/Blocks/chr14_-_2_74941962-106863556\n",
      "writing file K562_Chen_data/Blocks/chr15_+_0_17010550-49656366\n",
      "writing file K562_Chen_data/Blocks/chr15_+_1_49662429-76977692\n",
      "writing file K562_Chen_data/Blocks/chr15_+_2_76993403-101976501\n",
      "writing file K562_Chen_data/Blocks/chr14_+_0_16035740-52728720\n",
      "writing file K562_Chen_data/Blocks/chr14_+_1_52730167-76243553\n",
      "writing file K562_Chen_data/Blocks/chr14_+_2_76245922-106810202\n",
      "writing file K562_Chen_data/Blocks/chr10_+_0_39881-28673188\n",
      "writing file K562_Chen_data/Blocks/chr10_+_1_28677517-73131894\n",
      "writing file K562_Chen_data/Blocks/chr10_+_2_73146682-100562052\n",
      "writing file K562_Chen_data/Blocks/chr10_+_3_100563263-133785493\n"
     ]
    }
   ],
   "source": [
    "total = 0\n",
    "files = glob.glob(root_dir+\"/*.txt\")\n",
    "info = open(root_dir+'/Blocks/info.txt','w')\n",
    "info.write('ID\\tstart\\tend\\tlength\\tsites_num\\n')\n",
    "for file in files:\n",
    "    num_lines = sum(1 for line in open(file))\n",
    "    num_blocks = round(num_lines/Fixed_length)\n",
    "    len_blocks = num_lines/num_blocks\n",
    "    \n",
    "    f= open(file,'r')\n",
    "    pre_pos = 0\n",
    "    dict_line = OrderedDict()\n",
    "    #dict_line = dict()\n",
    "    count = 0\n",
    "    separate_num=0\n",
    "    save_block = 0\n",
    "    start = 0\n",
    "    \n",
    "    for i, line in enumerate(f):\n",
    "        line = line.rstrip('\\n')\n",
    "        if(i==0):\n",
    "            continue ###Skip header\n",
    "        chromosome,pos,strand = line.split('\\t')[0].split(':')\n",
    "        pos = int(pos)\n",
    "        count += 1\n",
    "        if(i==1):\n",
    "            start=pos\n",
    "        if(count>len_blocks and pos-pre_pos>1000 and save_block<num_blocks-1):\n",
    "            array = Gene_Loc[chromosome+strand]\n",
    "            index1,index2 = binary_locate(array,pre_pos,0,len(array)-1)\n",
    "            if(index1%2==1 and index2%2==0):\n",
    "                ww = open(root_dir+'/Blocks/%s_%s_%d'%(chromosome,strand,save_block),'w')\n",
    "                print('writing file '+root_dir+'/Blocks/%s_%s_%d_%d-%d'%(chromosome,strand,save_block,start,pre_pos))\n",
    "                info.write('%s_%s_%d\\t%d\\t%d\\t%d\\t%d\\n'%(chromosome,strand,save_block,start,pre_pos,pre_pos-start,count))\n",
    "                #print('%s_%s_%d\\t%d\\t%d\\t%d\\t%d\\n'%(chromosome,strand,save_block,start,pre_pos,pre_pos-start,count))\n",
    "                for key,val in dict_line.items():\n",
    "                    ww.write('%s\\n'%val)\n",
    "                ww.close()\n",
    "                dict_line.clear()\n",
    "                count = 0\n",
    "                save_block += 1\n",
    "                start  = pos\n",
    "            \n",
    "        \n",
    "        dict_line[pos] = line\n",
    "        pre_pos = pos\n",
    "        \n",
    "    out = open(root_dir+'/Blocks/%s_%s_%d'%(chromosome,strand,save_block),'w')\n",
    "    print('writing file '+root_dir+'/Blocks/%s_%s_%d_%d-%d'%(chromosome,strand,save_block,start,pre_pos))\n",
    "    info.write('%s_%s_%d\\t%d\\t%d\\t%d\\t%d\\n'%(chromosome,strand,save_block,start,pre_pos,pre_pos-start,count))\n",
    "    for key,val in dict_line.items():\n",
    "        out.write('%s\\n'%(val))\n",
    "    out.close()\n",
    "\n",
    "info.close()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
